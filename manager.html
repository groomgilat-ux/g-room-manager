<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G-Room Manager</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map for Modules -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>

    <style>
        body { background-color: #030712; color: white; font-family: sans-serif; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Users, Calendar, DollarSign, Settings, LogOut, Plus, Save, Clock, 
            FileText, Mail, CheckCircle, XCircle, AlertTriangle, Lock, Menu, 
            X, User, LayoutDashboard, Send, CalendarRange, Download, UploadCloud, 
            File, ChevronLeft, ChevronRight, Activity, MapPin, Database, Loader, 
            Trash2, Bell, Check, X as XIcon, Cake, Wifi, WifiOff
        } from 'lucide-react';

        import { initializeApp } from 'firebase/app';
        import { 
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged 
        } from 'firebase/auth';
        import { 
            getFirestore, collection, doc, setDoc, addDoc, updateDoc, deleteDoc, 
            onSnapshot, query, orderBy 
        } from 'firebase/firestore';

        // --- Configuration (Hardcoded with your keys) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBvayS247KEOVqZloFrNWV3svg4DSiNG08",
            authDomain: "g-room-escape-room-management.firebaseapp.com",
            projectId: "g-room-escape-room-management",
            storageBucket: "g-room-escape-room-management.firebasestorage.app",
            messagingSenderId: "361117379721",
            appId: "1:361117379721:web:3019eaeb30f4fe188caa58",
            measurementId: "G-6TSPGPBF4H"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        // Connect specifically to the 'groom' database
        const db = getFirestore(app, 'groom');

        // Helper to handle paths - DIRECT ACCESS TO ROOT
        const getCollectionRef = (collectionName) => collection(db, collectionName);
        const getDocRef = (collectionName, docId) => doc(db, collectionName, docId);

        // --- Initial Data Fallback ---
        const INITIAL_SETTINGS_FALLBACK = {
            businessName: 'G-Room Escape',
            senderEmail: 'manager@g-room.co.il',
            adminCode: 'admin123',
            logo: null,
            primaryColor: '#8b5cf6',
            secondaryColor: '#1f2937',
            emailTemplate: {
                subject: 'G-Room: ×ª×œ×•×© ×©×›×¨ ×œ×—×•×“×© {month}/{year}',
                body: '×”×™×™ {name},\n\n××¦×•×¨×£ ×ª×œ×•×© ×”×©×›×¨ ×©×œ×š ×¢×‘×•×¨ ×—×•×“×© {month}/{year}.\n\n×‘×‘×¨×›×”,\n×”× ×”×œ×ª G-Room'
            },
            openingHours: {
                Sunday: { start: '10:00', end: '23:00' },
                Monday: { start: '10:00', end: '23:00' },
                Tuesday: { start: '10:00', end: '23:00' },
                Wednesday: { start: '10:00', end: '23:00' },
                Thursday: { start: '10:00', end: '01:00' },
                Friday: { start: '09:00', end: '15:00' },
                Saturday: { start: '18:00', end: '01:00' },
            }
        };

        // --- Utilities ---
        const addTime = (timeStr, minutesToAdd) => {
            if (!timeStr) return '';
            const [hours, minutes] = timeStr.split(':').map(Number);
            const date = new Date();
            date.setHours(hours, minutes + minutesToAdd);
            return date.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit', hour12: false });
        };

        const exportToXLS = (salaryReport, filename) => {
            let tableRows = '';

            salaryReport.forEach(emp => {
                if (emp.empShifts.length > 0) {
                    tableRows += `
                        <tr><td colspan="7" style="background-color: #e0e7ff; font-weight: bold; text-align: center;">${emp.name} (×ª.×–/×§×•×“: ${emp.code})</td></tr>
                        <tr style="background-color: #f3f4f6; font-weight: bold;">
                            <td>×ª××¨×™×š</td>
                            <td>×©×¢×ª ×”×ª×—×œ×”</td>
                            <td>×©×¢×ª ×¡×™×•× (××©×•×¢×¨×ª)</td>
                            <td>×—×“×¨</td>
                            <td>×›××•×ª ××©×—×§×™×</td>
                            <td>×ª×¢×¨×™×£ ×œ××©×—×§</td>
                            <td>×¡×”"×› ×œ××©××¨×ª</td>
                        </tr>
                    `;

                    emp.empShifts.forEach(s => {
                        const endTime = addTime(s.startTime, s.gamesCount * 90); 
                        const shiftWage = s.gamesCount * emp.wagePerGame;
                        tableRows += `
                            <tr>
                                <td>${s.date}</td>
                                <td>${s.startTime}</td>
                                <td>${endTime}</td>
                                <td>${s.room}</td>
                                <td>${s.gamesCount}</td>
                                <td>â‚ª${emp.wagePerGame}</td>
                                <td>â‚ª${shiftWage}</td>
                            </tr>
                        `;
                    });

                    tableRows += `
                        <tr>
                            <td colspan="6" style="text-align: left; font-weight: bold; padding: 5px;">×¡×”"×› ×©×›×¨ ×œ×ª×©×œ×•× ×¢×‘×•×¨ ${emp.name}:</td>
                            <td style="font-weight: bold; background-color: #dcfce7;">â‚ª${emp.totalWage}</td>
                        </tr>
                        <tr><td colspan="7" style="height: 10px;"></td></tr>
                    `;
                }
            });

            let tableHTML = `
                <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
                <head><meta charset="UTF-8"><style>table { border-collapse: collapse; width: 100%; font-family: Arial; } th, td { border: 1px solid #ccc; padding: 5px; text-align: right; }</style></head>
                <body dir="rtl"><table>${tableRows}</table></body></html>
            `;

            const blob = new Blob([tableHTML], { type: 'application/vnd.ms-excel' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = filename || `Salary_Report.xls`;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        };

        const replacePlaceholders = (template, data) => {
            if (!template) return '';
            let result = template;
            Object.keys(data).forEach(key => {
                result = result.replace(new RegExp(`{${key}}`, 'g'), data[key]);
            });
            return result;
        };

        const timeoutPromise = (promise, ms = 5000) => {
            return Promise.race([
                promise,
                new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout")), ms))
            ]);
        };

        // --- UI Components ---
        const Button = ({ children, onClick, variant = 'primary', className = '', disabled, ...props }) => {
            const variants = {
                primary: "bg-indigo-600 hover:bg-indigo-700 text-white",
                secondary: "bg-gray-700 hover:bg-gray-600 text-gray-100",
                danger: "bg-red-600 hover:bg-red-700 text-white",
                success: "bg-green-600 hover:bg-green-700 text-white",
                outline: "border-2 border-indigo-600 text-indigo-400 hover:bg-indigo-900/20"
            };
            return <button onClick={onClick} className={`px-4 py-2 rounded-lg font-medium flex items-center justify-center gap-2 shadow-md transition-all disabled:opacity-50 ${variants[variant]} ${className}`} disabled={disabled} {...props}>{children}</button>;
        };

        const Card = ({ title, children, className = '' }) => (
            <div className={`bg-gray-900 border border-gray-800 rounded-xl p-6 shadow-xl ${className}`}>
                {title && <h3 className="text-xl font-bold text-gray-100 mb-4 border-b border-gray-800 pb-2">{title}</h3>}
                {children}
            </div>
        );

        const Input = ({ label, type = "text", value, onChange, className = "", ...props }) => (
            <div className={`flex flex-col gap-1 ${className}`}>
                {label && <label className="text-sm text-gray-400 font-medium">{label}</label>}
                <input 
                    type={type} value={value} onChange={onChange}
                    className="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all disabled:opacity-50"
                    {...props}
                />
            </div>
        );

        // --- Main App Logic ---
        function GRoomApp() {
            const [user, setUser] = useState(null);
            const [currentUser, setCurrentUser] = useState(null);
            const [employees, setEmployees] = useState([]);
            const [shifts, setShifts] = useState([]);
            const [constraints, setConstraints] = useState([]);
            const [requests, setRequests] = useState([]);
            const [settings, setSettings] = useState(INITIAL_SETTINGS_FALLBACK);
            const [loading, setLoading] = useState(true);
            const [loginCode, setLoginCode] = useState('');
            const [selectedEmpId, setSelectedEmpId] = useState('');
            const [dbConnected, setDbConnected] = useState(false);

            useEffect(() => {
                const initAuth = async () => { try { await signInAnonymously(auth); } catch (e) { console.error("Auth error:", e); } };
                initAuth();
                return onAuthStateChanged(auth, setUser);
            }, []);

            useEffect(() => {
                if (!user) return;
                setLoading(true);
                
                // Listeners
                const unsubEmp = onSnapshot(getCollectionRef('employees'), (s) => {
                    setEmployees(s.docs.map(d => ({id: d.id, ...d.data()})));
                    setDbConnected(true);
                }, (error) => {
                    console.error("DB Error (Employees):", error);
                    setDbConnected(false);
                    if(error.code === 'permission-denied') alert("×©×’×™××ª ×”×¨×©××•×ª! × × ×•×•×“× ×©×©×™× ×™×ª ××ª ×”-Rules ×‘-Firebase ×œ-allow read, write: if true;");
                });

                const unsubShift = onSnapshot(getCollectionRef('shifts'), s => setShifts(s.docs.map(d => ({id: d.id, ...d.data()}))));
                const unsubCon = onSnapshot(getCollectionRef('constraints'), s => setConstraints(s.docs.map(d => ({id: d.id, ...d.data()}))));
                const unsubReq = onSnapshot(getCollectionRef('requests'), s => setRequests(s.docs.map(d => ({id: d.id, ...d.data()}))));
                const unsubSet = onSnapshot(getCollectionRef('app_settings'), s => {
                    if (!s.empty) {
                        const globalDoc = s.docs.find(d => d.id === 'global') || s.docs[0];
                        if (globalDoc) setSettings(prev => ({...prev, ...globalDoc.data()}));
                    }
                    setLoading(false);
                });
                return () => { unsubEmp(); unsubShift(); unsubCon(); unsubReq(); unsubSet(); };
            }, [user]);

            useEffect(() => document.documentElement.style.setProperty('--primary-color', settings.primaryColor), [settings.primaryColor]);

            const handleLogin = () => {
                const allowInit = employees.length === 0;
                if ((selectedEmpId === 'admin' && loginCode === settings.adminCode) || (selectedEmpId === 'admin' && allowInit && loginCode === 'admin123')) {
                    setCurrentUser({ role: 'admin', name: '×× ×”×œ ×”××¢×¨×›×ª' });
                } else {
                    const emp = employees.find(e => e.id === selectedEmpId);
                    if (emp && emp.code === loginCode) setCurrentUser({ role: 'employee', data: emp });
                    else alert("×¤×¨×˜×™ ×”×ª×—×‘×¨×•×ª ×©×’×•×™×™×");
                }
            };

            const handleLogout = () => { setCurrentUser(null); setLoginCode(''); setSelectedEmpId(''); };

            if (loading) return <div className="min-h-screen bg-gray-950 flex items-center justify-center text-indigo-500"><Loader className="animate-spin w-10 h-10" /></div>;

            if (!currentUser) return (
                <div className="min-h-screen bg-gray-950 text-white flex items-center justify-center p-4">
                    <div className="max-w-md w-full bg-gray-900 p-8 rounded-2xl border border-gray-800 text-center relative">
                        {/* DB Status Indicator */}
                        <div className={`absolute top-4 right-4 w-3 h-3 rounded-full ${dbConnected ? 'bg-green-500' : 'bg-red-500 animate-pulse'}`} title={dbConnected ? '××—×•×‘×¨ ×œ×¢× ×Ÿ' : '××™×Ÿ ×—×™×‘×•×¨ ×œ×¢× ×Ÿ (×‘×“×•×§ ×”×¨×©××•×ª)'}></div>
                        
                        <div className="mb-8">
                            {settings.logo ? <img src={settings.logo} className="h-24 mx-auto mb-4 object-contain"/> : <div className="h-24 w-24 bg-indigo-900/50 rounded-full mx-auto flex items-center justify-center mb-4"><Lock size={40}/></div>}
                            <h1 className="text-3xl font-bold">{settings.businessName}</h1>
                            <p className="text-gray-400 mt-2">×¤×•×¨×˜×œ × ×™×”×•×œ ×¢×•×‘×“×™× (App)</p>
                        </div>
                        <div className="space-y-4">
                            <select className="w-full bg-gray-800 border border-gray-700 rounded-lg p-3" value={selectedEmpId} onChange={e => setSelectedEmpId(e.target.value)}>
                                <option value="">-- ×‘×—×¨ ××©×ª××© --</option>
                                <option value="admin">ğŸ”’ ×× ×”×œ ××¢×¨×›×ª</option>
                                {employees.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                            </select>
                            <input type="password" className="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-center tracking-widest" value={loginCode} onChange={e => setLoginCode(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleLogin()} placeholder="****" />
                            <Button onClick={handleLogin} className="w-full py-3 text-lg">×›× ×™×¡×”</Button>
                            {!dbConnected && <p className="text-red-400 text-xs">×©×’×™××ª ×—×™×‘×•×¨ ×œ××¡×“ ×”× ×ª×•× ×™×. ×•×•×“× ×©×¤×ª×—×ª ×”×¨×©××•×ª ×‘-Firebase Console ×¢×‘×•×¨ ××¡×“ ×”× ×ª×•× ×™× <b>groom</b>.</p>}
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-gray-950 text-gray-100 font-sans">
                    <header className="bg-gray-900 border-b border-gray-800 sticky top-0 z-50 h-16 flex items-center justify-between px-6">
                        <div className="flex items-center gap-3">
                            {settings.logo && <img src={settings.logo} className="h-8 w-8 rounded object-cover"/>}
                            <span className="font-bold text-xl">{settings.businessName}</span>
                            <span className="text-xs bg-gray-800 px-2 py-1 rounded-full border border-gray-700 flex items-center gap-2">
                                {currentUser.role === 'admin' ? '×× ×”×œ' : '×¢×•×‘×“'}
                                <div className={`w-2 h-2 rounded-full ${dbConnected ? 'bg-green-500' : 'bg-red-500'}`}></div>
                            </span>
                        </div>
                        <Button variant="ghost" onClick={() => {setCurrentUser(null); setLoginCode(''); setSelectedEmpId('');}} className="text-red-400"><LogOut size={18} /> ×™×¦×™××”</Button>
                    </header>
                    <main className="max-w-7xl mx-auto px-4 py-8">
                        {currentUser.role === 'admin' ? 
                            <AdminDashboard employees={employees} shifts={shifts} constraints={constraints} settings={settings} requests={requests} /> : 
                            <EmployeeDashboard employee={currentUser.data} shifts={shifts} constraints={constraints} settings={settings} />
                        }
                    </main>
                </div>
            );
        }

        // --- Admin Components ---
        const AdminDashboard = ({ employees, shifts, constraints, settings, requests }) => {
            const [tab, setTab] = useState('employees');
            const pending = requests.filter(r => r.status === 'pending');
            const menu = [
                {id:'employees', label:'×¢×•×‘×“×™×', icon:Users}, {id:'shifts', label:'×“×•×—×•×ª', icon:FileText}, 
                {id:'constraints', label:'×–××™× ×•×ª', icon:Calendar}, {id:'settings', label:'×”×’×“×¨×•×ª', icon:Settings}
            ];
            
            return (
                <div className="space-y-6">
                    <div className="flex flex-wrap gap-2 border-b border-gray-800 pb-2">
                        {menu.map(m => <button key={m.id} onClick={()=>setTab(m.id)} className={`flex items-center gap-2 px-4 py-2 rounded-t-lg transition-colors ${tab===m.id ? 'bg-indigo-600/10 text-indigo-400 border-b-2 border-indigo-500' : 'text-gray-400 hover:bg-gray-800'}`}><m.icon size={18}/> {m.label}</button>)}
                        {pending.length > 0 && <button onClick={()=>setTab('requests')} className={`flex items-center gap-2 px-4 py-2 rounded-t-lg ml-auto transition-colors ${tab==='requests' ? 'bg-indigo-600/10 text-indigo-400 border-b-2 border-indigo-500' : 'text-yellow-400'}`}><Bell size={18} className="animate-bounce"/><span className="font-bold">{pending.length}</span></button>}
                    </div>
                    <div className="fade-in">
                        {tab==='employees' && <AdminEmployees employees={employees}/>}
                        {tab==='shifts' && <AdminReports employees={employees} shifts={shifts} settings={settings}/>}
                        {tab==='constraints' && <AdminConstraints employees={employees} constraints={constraints} settings={settings}/>}
                        {tab==='settings' && <AdminSettings settings={settings}/>}
                        {tab==='requests' && <AdminRequests requests={pending} employees={employees}/>}
                    </div>
                </div>
            );
        };

        const AdminSettings = ({ settings }) => {
            const update = async (k, v) => await setDoc(getDocRef('app_settings', 'global'), { ...settings, [k]: v }, { merge: true });
            const handleTemplate = async (k, v) => await update('emailTemplate', { ...settings.emailTemplate, [k]: v });
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const hebrewDays = { Sunday: '×¨××©×•×Ÿ', Monday: '×©× ×™', Tuesday: '×©×œ×™×©×™', Wednesday: '×¨×‘×™×¢×™', Thursday: '×—××™×©×™', Friday: '×©×™×©×™', Saturday: '×©×‘×ª' };

            return (
                <div className="grid md:grid-cols-2 gap-6">
                    <Card title="×›×œ×œ×™">
                        <div className="space-y-4">
                            <Input label="×©× ×”×¢×¡×§" value={settings.businessName} onChange={e => update('businessName', e.target.value)} />
                            <Input label="×§×•×“ ×›× ×™×¡×” ×œ×× ×”×œ" value={settings.adminCode} onChange={e => update('adminCode', e.target.value)} />
                            <Input label="×›×ª×•×‘×ª ××™×™×œ ×œ×©×œ×™×—×”" value={settings.senderEmail} onChange={e => update('senderEmail', e.target.value)} />
                            <div className="space-y-1"><label className="text-sm text-gray-400">×œ×•×’×• (URL)</label><input className="w-full bg-gray-800 border border-gray-700 rounded p-2" value={settings.logo || ''} onChange={e => update('logo', e.target.value)} /></div>
                            <div className="space-y-1"><label className="text-sm text-gray-400">×¦×‘×¢ ×¨××©×™</label><input type="color" value={settings.primaryColor} onChange={e => update('primaryColor', e.target.value)} className="w-full h-10 bg-transparent cursor-pointer"/></div>
                        </div>
                    </Card>
                    <div className="space-y-6">
                        <Card title="×ª×‘× ×™×ª ××™××™×™×œ">
                            <div className="space-y-4">
                                <Input label="× ×•×©×" value={settings.emailTemplate.subject} onChange={e => handleTemplate('subject', e.target.value)} />
                                <div className="space-y-1">
                                    <label className="text-sm text-gray-400">×ª×•×›×Ÿ (××©×ª× ×™×: {`{name}, {month}, {year}`})</label>
                                    <textarea className="w-full bg-gray-800 border border-gray-700 rounded p-2 h-32 text-white" value={settings.emailTemplate.body} onChange={e => handleTemplate('body', e.target.value)} />
                                </div>
                            </div>
                        </Card>
                        <Card title="×©×¢×•×ª ×¤×¢×™×œ×•×ª">
                            {days.map(d => {
                                const h = settings.openingHours[d] || {start:'00:00', end:'00:00'};
                                return (
                                    <div key={d} className="flex justify-between items-center my-2 text-sm">
                                        <span className="w-16 font-bold">{hebrewDays[d]}</span>
                                        <div className="flex gap-2">
                                            <input type="time" value={h.start} onChange={e => update('openingHours', {...settings.openingHours, [d]: {...h, start: e.target.value}})} className="bg-gray-800 rounded p-1"/>
                                            <span>-</span>
                                            <input type="time" value={h.end} onChange={e => update('openingHours', {...settings.openingHours, [d]: {...h, end: e.target.value}})} className="bg-gray-800 rounded p-1"/>
                                        </div>
                                    </div>
                                )
                            })}
                        </Card>
                    </div>
                </div>
            );
        };

        const AdminReports = ({ employees, shifts, settings }) => {
            const [month, setMonth] = useState(new Date().toISOString().slice(0, 7));
            const [manual, setManual] = useState(false);
            const [selEmp, setSelEmp] = useState('');
            const [saving, setSaving] = useState(false);
            
            const monthlyShifts = shifts.filter(s => s.date.startsWith(month));
            const report = employees.map(emp => {
                const empShifts = monthlyShifts.filter(s => s.employeeId === emp.id);
                const totalWage = empShifts.reduce((acc, s) => acc + (Number(s.gamesCount) * emp.wagePerGame), 0);
                return { ...emp, totalWage, empShifts };
            });
            const totalPay = report.reduce((acc, r) => acc + r.totalWage, 0);

            const handleManual = async (e) => {
                e.preventDefault();
                setSaving(true);
                const fd = new FormData(e.target);
                try {
                    await timeoutPromise(addDoc(getCollectionRef('shifts'), {
                        employeeId: fd.get('employeeId'), date: fd.get('date'), startTime: fd.get('startTime'),
                        gamesCount: Number(fd.get('gamesCount')), room: fd.get('room') || '×™×“× ×™', approved: true
                    }), 3000);
                    setManual(false);
                } catch(e) { 
                    if(e.message === 'Timeout') { setManual(false); }
                    else alert(e.message); 
                } finally { setSaving(false); }
            };

            const doExport = () => {
                exportToXLS(report, `Salary_Report_${month}.xls`);
            };

            const sendMail = (emp) => {
                const subj = replacePlaceholders(settings.emailTemplate.subject, { name: emp.name, month: month.split('-')[1], year: month.split('-')[0] });
                const body = replacePlaceholders(settings.emailTemplate.body, { name: emp.name, month: month.split('-')[1], year: month.split('-')[0] });
                const link = settings.senderEmail.includes('gmail') 
                    ? `https://mail.google.com/mail/?view=cm&fs=1&to=${emp.email}&su=${encodeURIComponent(subj)}&body=${encodeURIComponent(body)}`
                    : `mailto:${emp.email}?subject=${encodeURIComponent(subj)}&body=${encodeURIComponent(body)}`;
                window.open(link, '_blank');
            };

            const selEmpObj = employees.find(e => e.id === selEmp);

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center bg-gray-900 p-4 rounded-xl border border-gray-800">
                        <div><h2 className="text-xl font-bold">×“×•×—×•×ª ×©×›×¨</h2><p>×¡×”"×› ×œ×ª×©×œ×•×: <span className="text-green-400 font-bold">â‚ª{totalPay.toLocaleString()}</span></p></div>
                        <div className="flex gap-2">
                            <input type="month" value={month} onChange={e => setMonth(e.target.value)} className="bg-gray-800 border border-gray-700 rounded p-2"/>
                            <Button onClick={doExport} variant="success"><Download size={16}/> ××§×¡×œ</Button>
                            <Button onClick={() => setManual(true)} variant="secondary"><Plus size={16}/> ×™×“× ×™</Button>
                        </div>
                    </div>
                    <div className="space-y-4">
                        {report.map(r => (
                            <div key={r.id} className="bg-gray-900 border border-gray-800 rounded-xl overflow-hidden">
                                <div className="p-4 flex justify-between items-center">
                                    <div className="flex items-center gap-3"><div className="h-10 w-10 bg-indigo-600 rounded-full flex items-center justify-center font-bold">{r.name[0]}</div><span className="text-lg font-bold">{r.name}</span></div>
                                    <div className="text-green-400 font-bold text-xl">â‚ª{r.totalWage}</div>
                                    <Button size="sm" variant="outline" onClick={() => sendMail(r)}><Mail size={16}/></Button>
                                </div>
                                {r.empShifts.length > 0 && (
                                    <div className="bg-gray-950/50 p-2 text-sm border-t border-gray-800">
                                        <div className="grid grid-cols-6 text-gray-500 mb-2 px-2 text-xs font-bold"><div>×ª××¨×™×š</div><div>×©×¢×”</div><div>×—×“×¨</div><div>××©×—×§×™×</div><div>×¡×˜×˜×•×¡</div><div>××—×§</div></div>
                                        {r.empShifts.map(s => (
                                            <div key={s.id} className="grid grid-cols-6 py-2 px-2 border-b border-gray-800 items-center hover:bg-gray-800/30">
                                                <div>{s.date}</div><div>{s.startTime}</div><div>{s.room}</div><div>{s.gamesCount}</div>
                                                <div className="text-green-400"><CheckCircle size={14}/></div>
                                                <button onClick={() => confirm("×œ××—×•×§?") && deleteDoc(getDocRef('shifts', s.id))} className="text-red-500"><Trash2 size={14}/></button>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                    {manual && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
                            <div className="bg-gray-900 p-6 rounded-xl w-full max-w-md border border-gray-700">
                                <h3 className="text-xl font-bold mb-4">×”×•×¡×¤×” ×™×“× ×™×ª</h3>
                                <form onSubmit={handleManual} className="space-y-4">
                                    <select name="employeeId" className="w-full bg-gray-800 border border-gray-700 rounded p-2" required value={selEmp} onChange={e => setSelEmp(e.target.value)}>
                                        <option value="">×‘×—×¨ ×¢×•×‘×“...</option>
                                        {employees.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                                    </select>
                                    <Input name="date" type="date" required />
                                    <Input name="startTime" type="time" required />
                                    <Input name="gamesCount" type="number" required />
                                    {selEmpObj ? (
                                        <select name="room" className="w-full bg-gray-800 border border-gray-700 rounded p-2">
                                            {selEmpObj.skills.map(s => <option key={s} value={s}>{s}</option>)}
                                            <option value="×™×“× ×™">××—×¨</option>
                                        </select>
                                    ) : <Input name="room" placeholder="×—×“×¨" />}
                                    <div className="flex gap-2"><Button type="button" variant="secondary" onClick={()=>setManual(false)} className="flex-1">×‘×™×˜×•×œ</Button><Button type="submit" className="flex-1" disabled={saving}>{saving?'×©×•××¨...':'×©××•×¨'}</Button></div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const AdminConstraints = ({ employees, constraints, settings }) => {
            const [offset, setOffset] = useState(0);
            const days = useMemo(() => Array.from({length:7}, (_,i) => {
                const d = new Date(); d.setDate(d.getDate() + (offset*7) + i); return d;
            }), [offset]);
            const hours = Array.from({length:17}, (_,i) => i+8);

            const getStatus = (d, h) => {
                const dStr = d.toISOString().slice(0,10);
                const dayName = d.toLocaleDateString('en-US', {weekday:'long'});
                const biz = settings.openingHours[dayName];
                if (!biz) return -1;
                const open = parseInt(biz.start.split(':')[0]);
                const close = parseInt(biz.end.split(':')[0]);
                const effClose = close < open ? close+24 : close;
                const check = h < open && h+24 < effClose ? h+24 : h;
                if (check < open || check >= effClose) return -1;

                let count = 0;
                employees.forEach(emp => {
                    const busy = constraints.some(c => {
                        if (c.employeeId !== emp.id) return false;
                        if (c.type === 'range') return dStr >= c.startDate && dStr <= c.endDate;
                        const cs = parseInt(c.startTime.split(':')[0]);
                        const ce = parseInt(c.endTime.split(':')[0]);
                        return c.date === dStr && h >= cs && h < ce;
                    });
                    if (!busy) count++;
                });
                return count;
            };

            const dayTitle = (d) => d.toLocaleDateString('he-IL', {weekday:'short', day:'numeric', month:'numeric'});

            return (
                <div className="space-y-6">
                    <Card title="××¤×ª ×–××™× ×•×ª">
                        <div className="flex justify-between mb-4">
                            <Button onClick={()=>setOffset(p=>p-1)}><ChevronRight size={16}/></Button>
                            <span>{dayTitle(days[0])} - {dayTitle(days[6])}</span>
                            <Button onClick={()=>setOffset(p=>p+1)}><ChevronLeft size={16}/></Button>
                        </div>
                        <div className="overflow-x-auto">
                            <div className="min-w-[800px]">
                                <div className="grid grid-cols-8 gap-1 mb-1 text-center font-bold">
                                    <div className="bg-gray-900 p-2">×©×¢×”</div>
                                    {days.map((d,i) => <div key={i} className="bg-gray-800 p-2 text-sm">{dayTitle(d)}</div>)}
                                </div>
                                {hours.map(h => (
                                    <div key={h} className="grid grid-cols-8 gap-1 mb-1 text-center text-xs">
                                        <div className="bg-gray-900 p-2">{h.toString().padStart(2,'0')}:00</div>
                                        {days.map((d,i) => {
                                            const stat = getStatus(d, h);
                                            let bg = 'bg-green-900/40';
                                            if (stat === -1) bg = 'bg-gray-800/30 opacity-50';
                                            else if (stat === 0) bg = 'bg-red-900/60';
                                            else if (stat === 1) bg = 'bg-yellow-900/60';
                                            return <div key={i} className={`p-2 rounded ${bg}`}>{stat > -1 ? stat : ''}</div>
                                        })}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </Card>
                    <Card title="××™×œ×•×¦×™× ×‘×¨×©×™××”">
                        <table className="w-full text-right text-sm">
                            <thead className="text-gray-400"><tr><th>×¢×•×‘×“</th><th>×ª××¨×™×š</th><th>×©×¢×•×ª</th></tr></thead>
                            <tbody>
                                {constraints.map(c => {
                                    const emp = employees.find(e => e.id === c.employeeId);
                                    return <tr key={c.id} className="border-b border-gray-800">
                                        <td className="py-2">{emp?.name}</td>
                                        <td>{c.type==='range' ? `${c.startDate}-${c.endDate}` : c.date}</td>
                                        <td>{c.type==='range' ? '×—×•×¤×©' : `${c.startTime}-${c.endTime}`}</td>
                                    </tr>
                                })}
                            </tbody>
                        </table>
                    </Card>
                </div>
            );
        };

        const AdminEmployees = ({ employees }) => {
            const [open, setOpen] = useState(false);
            const [edit, setEdit] = useState(null);
            const [saving, setSaving] = useState(false);

            const save = async (e) => {
                e.preventDefault();
                setSaving(true);
                const fd = new FormData(e.target);
                const data = {
                    name: fd.get('name'), phone: fd.get('phone'), email: fd.get('email'), code: fd.get('code'),
                    address: fd.get('address'), birthday: fd.get('birthday'), wagePerGame: Number(fd.get('wagePerGame')),
                    form101: fd.get('form101') === 'on', skills: fd.get('skills').split(',').map(s=>s.trim())
                };
                try {
                    const timeout = new Promise((_, r) => setTimeout(() => r(new Error("Timeout")), 5000));
                    if(edit) await Promise.race([updateDoc(getDocRef('employees', edit.id), data), timeout]);
                    else await Promise.race([addDoc(getCollectionRef('employees'), data), timeout]);
                    setOpen(false);
                } catch(e) { if(e.message === 'Timeout') { alert('× ×©×œ×—'); setOpen(false); } else alert(e.message); } finally { setSaving(false); }
            };

            const del = async (id) => { if(confirm("×œ××—×•×§?")) await deleteDoc(getDocRef('employees', id)); };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between"><h2 className="text-2xl font-bold">× ×™×”×•×œ ×¢×•×‘×“×™×</h2><Button onClick={()=>{setEdit(null); setOpen(true);}}><Plus size={18}/> ×”×•×¡×£ ×¢×•×‘×“</Button></div>
                    <div className="grid md:grid-cols-3 gap-4">
                        {employees.map(e => (
                            <Card key={e.id} className="relative group hover:border-indigo-500">
                                <div className="absolute top-4 left-4 opacity-0 group-hover:opacity-100 flex gap-2">
                                    <button onClick={()=>{setEdit(e); setOpen(true);}} className="bg-gray-900 p-1 rounded text-indigo-400">×¢×¨×•×š</button>
                                    <button onClick={()=>del(e.id)} className="bg-gray-900 p-1 rounded text-red-400"><Trash2 size={16}/></button>
                                </div>
                                <h3 className="font-bold text-lg">{e.name}</h3>
                                <p className="text-sm text-gray-400">{e.phone}</p>
                                <div className="mt-2 text-sm text-gray-300">
                                    <div>×§×•×“: {e.code}</div>
                                    <div>×ª×¢×¨×™×£: â‚ª{e.wagePerGame}</div>
                                    <div>×™×•× ×”×•×œ×“×ª: {e.birthday}</div>
                                    <div className="text-xs text-gray-500 mt-1">{e.skills.join(', ')}</div>
                                </div>
                            </Card>
                        ))}
                    </div>
                    {open && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
                            <div className="bg-gray-900 p-6 rounded-xl w-full max-w-2xl border border-gray-700 max-h-[90vh] overflow-y-auto">
                                <h3 className="text-xl font-bold mb-4">{edit ? '×¢×¨×™×›×”' : '×—×“×©'}</h3>
                                <form onSubmit={save} className="space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <Input label="×©×" name="name" required defaultValue={edit?.name}/>
                                        <Input label="×˜×œ×¤×•×Ÿ" name="phone" required defaultValue={edit?.phone}/>
                                        <Input label="××™×™×œ" name="email" type="email" required defaultValue={edit?.email}/>
                                        <Input label="×§×•×“" name="code" required defaultValue={edit?.code}/>
                                        <Input label="×›×ª×•×‘×ª" name="address" className="col-span-2" defaultValue={edit?.address}/>
                                        <Input label="×™×•× ×”×•×œ×“×ª" name="birthday" type="date" defaultValue={edit?.birthday}/>
                                        <Input label="×©×›×¨ ×œ××©×—×§" name="wagePerGame" type="number" required defaultValue={edit?.wagePerGame}/>
                                        <Input label="×”×¡××›×•×ª (××•×¤×¨×“ ×‘×¤×¡×™×§)" name="skills" className="col-span-2" defaultValue={edit?.skills?.join(', ')}/>
                                    </div>
                                    <div className="flex gap-2"><input type="checkbox" name="form101" defaultChecked={edit?.form101}/> <label>×˜×•×¤×¡ 101</label></div>
                                    <div className="flex gap-2 pt-4"><Button type="button" variant="secondary" onClick={()=>setOpen(false)} className="flex-1">×‘×™×˜×•×œ</Button><Button type="submit" disabled={saving} className="flex-1">{saving?'×©×•××¨...':'×©××•×¨ ×‘×¢× ×Ÿ'}</Button></div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const AdminRequests = ({ requests, employees }) => {
            const handle = async (req, status) => {
                try {
                    if(status === 'approved') await timeoutPromise(updateDoc(getDocRef('employees', req.employeeId), req.newData), 3000);
                    await timeoutPromise(updateDoc(getDocRef('requests', req.id), { status }), 3000);
                } catch(e) {
                    if (e.message !== 'Timeout') alert(e.message);
                }
            };
            return (
                <div className="space-y-4">
                    <h2 className="text-xl font-bold">×‘×§×©×•×ª ×¢×“×›×•×Ÿ</h2>
                    {requests.length === 0 && <p className="text-gray-500">××™×Ÿ ×‘×§×©×•×ª ×—×“×©×•×ª</p>}
                    {requests.map(r => {
                        const emp = employees.find(e => e.id === r.employeeId);
                        return (
                            <Card key={r.id} className="border-r-4 border-yellow-500 flex justify-between items-start">
                                <div>
                                    <h3 className="font-bold text-lg mb-1">{emp?.name}</h3>
                                    <div className="text-sm text-gray-400 space-y-1">
                                        <p>×˜×œ×¤×•×Ÿ: {r.newData.phone}</p><p>××™×™×œ: {r.newData.email}</p><p>×›×ª×•×‘×ª: {r.newData.address}</p><p>×™×•× ×”×•×œ×“×ª: {r.newData.birthday}</p>
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <Button variant="success" onClick={()=>handle(r, 'approved')}><Check size={16}/></Button>
                                    <Button variant="danger" onClick={()=>handle(r, 'rejected')}><XIcon size={16}/></Button>
                                </div>
                            </Card>
                        )
                    })}
                </div>
            );
        };

        const EmployeeDashboard = ({ employee, shifts, constraints, settings }) => {
            const [tab, setTab] = useState('report');
            return (
                <div className="space-y-6">
                    <div className="flex bg-gray-900 p-1 rounded-lg w-fit">
                        {['report', 'constraints', 'profile'].map(t => (
                            <button key={t} onClick={()=>setTab(t)} className={`px-6 py-2 rounded ${tab===t?'bg-indigo-600':''}`}>{t==='report'?'×“×™×•×•×—':t==='constraints'?'××™×œ×•×¦×™×':'×¤×¨×•×¤×™×œ'}</button>
                        ))}
                    </div>
                    {tab==='report' && <EmployeeReport employee={employee} shifts={shifts}/>}
                    {tab==='constraints' && <EmployeeConstraints employee={employee} constraints={constraints}/>}
                    {tab==='profile' && <EmployeeProfile employee={employee} shifts={shifts}/>}
                </div>
            );
        };

        const EmployeeReport = ({ employee, shifts }) => {
            const [date, setDate] = useState(new Date().toISOString().slice(0, 10));
            const [start, setStart] = useState('');
            const [games, setGames] = useState(1);
            const [room, setRoom] = useState(employee.skills[0] || '');
            
            const submit = async (e) => {
                e.preventDefault();
                const today = new Date();
                const selDate = new Date(date);
                if (selDate.getMonth() < today.getMonth() && today.getDate() > 3) return alert("×œ× × ×™×ª×Ÿ ×œ×“×•×•×— ×¢×œ ×—×•×“×© ×©×¢×‘×¨ ××—×¨×™ ×”-3 ×œ×—×•×“×©");
                await addDoc(getCollectionRef('shifts'), { employeeId: employee.id, date, startTime: start, gamesCount: Number(games), room, approved: false });
                alert('×”××©××¨×ª × ×©×œ×—×”'); setStart(''); setGames(1);
            };
            const myShifts = shifts.filter(s => s.employeeId === employee.id).sort((a,b) => b.date.localeCompare(a.date));

            return (
                <div className="grid md:grid-cols-2 gap-6">
                    <Card title="×“×™×•×•×— ××©××¨×ª">
                        <form onSubmit={submit} className="space-y-4">
                            <Input label="×ª××¨×™×š" type="date" value={date} onChange={e=>setDate(e.target.value)} required />
                            <Input label="×©×¢×”" type="time" value={start} onChange={e=>setStart(e.target.value)} required />
                            <label className="block text-sm text-gray-400">×—×“×¨</label>
                            <select className="w-full bg-gray-800 p-2 rounded" value={room} onChange={e=>setRoom(e.target.value)}>{employee.skills.map(s=><option key={s} value={s}>{s}</option>)}</select>
                            <Input label="××©×—×§×™×" type="number" value={games} onChange={e=>setGames(e.target.value)} required />
                            <Button type="submit" className="w-full">×©×œ×—</Button>
                        </form>
                    </Card>
                    <Card title="×”×™×¡×˜×•×¨×™×”">
                        {myShifts.map(s => (
                            <div key={s.id} className="flex justify-between border-b border-gray-800 py-2">
                                <span>{s.date} {s.startTime}</span>
                                <span className={s.approved ? 'text-green-400' : 'text-yellow-400'}>{s.approved ? '××•×©×¨' : '×××ª×™×Ÿ'}</span>
                            </div>
                        ))}
                    </Card>
                </div>
            );
        };

        const EmployeeConstraints = ({ employee, constraints }) => {
            const [mode, setMode] = useState('single');
            const [date, setDate] = useState('');
            const [start, setStart] = useState('');
            const [end, setEnd] = useState('');
            const [sDate, setSDate] = useState('');
            const [eDate, setEDate] = useState('');

            const submit = async (e) => {
                e.preventDefault();
                const data = { employeeId: employee.id, type: mode };
                if (mode === 'single') { data.date = date; data.startTime = start; data.endTime = end; }
                else { data.startDate = sDate; data.endDate = eDate; }
                await addDoc(getCollectionRef('constraints'), data);
                alert('××™×œ×•×¥ × ×•×¡×£');
            };

            return (
                <div className="grid md:grid-cols-2 gap-6">
                    <Card title="××™×œ×•×¥ ×—×“×©">
                        <div className="flex gap-2 mb-4"><button onClick={()=>setMode('single')} className={`flex-1 p-1 rounded ${mode==='single'?'bg-indigo-600':''}`}>×™×•× ×‘×•×“×“</button><button onClick={()=>setMode('range')} className={`flex-1 p-1 rounded ${mode==='range'?'bg-indigo-600':''}`}>×—×•×¤×©×”</button></div>
                        <form onSubmit={submit} className="space-y-4">
                            {mode==='single' ? (
                                <>
                                    <Input type="date" value={date} onChange={e=>setDate(e.target.value)} required/>
                                    <div className="flex gap-4"><Input type="time" value={start} onChange={e=>setStart(e.target.value)} required/><Input type="time" value={end} onChange={e=>setEnd(e.target.value)} required/></div>
                                </>
                            ) : (
                                <><Input label="×" type="date" value={sDate} onChange={e=>setSDate(e.target.value)} required/><Input label="×¢×“" type="date" value={eDate} onChange={e=>setEDate(e.target.value)} required/></>
                            )}
                            <Button type="submit" className="w-full">×©×œ×—</Button>
                        </form>
                    </Card>
                    <Card title="×”××™×œ×•×¦×™× ×©×œ×™">
                        {constraints.filter(c => c.employeeId === employee.id).map(c => (
                            <div key={c.id} className="border-b border-gray-800 py-2 text-sm flex justify-between">
                                <span>{c.type==='range' ? `${c.startDate}-${c.endDate}` : c.date}</span>
                                <span>{c.type==='range' ? '×—×•×¤×©' : `${c.startTime}-${c.endTime}`}</span>
                            </div>
                        ))}
                    </Card>
                </div>
            );
        };

        const EmployeeProfile = ({ employee, shifts }) => {
            const [open, setOpen] = useState(false);
            const [sending, setSending] = useState(false);
            const month = new Date().toISOString().slice(0, 7);
            const myShifts = shifts.filter(s => s.employeeId === employee.id && s.date.startsWith(month));
            const wage = myShifts.reduce((acc, curr) => acc + (curr.gamesCount * employee.wagePerGame), 0);

            const request = async (e) => {
                e.preventDefault();
                setSending(true);
                const fd = new FormData(e.target);
                try {
                    await timeoutPromise(addDoc(getCollectionRef('requests'), {
                        employeeId: employee.id, status: 'pending', date: new Date().toISOString(),
                        newData: { phone: fd.get('phone'), email: fd.get('email'), address: fd.get('address'), birthday: fd.get('birthday') }
                    }), 3000);
                    alert('× ×©×œ×— ×‘×”×¦×œ×—×”'); 
                    setOpen(false);
                } catch(e) {
                    if (e.message === 'Timeout') { alert('× ×©×œ×— (××™×˜×™)'); setOpen(false); }
                    else alert(e.message);
                } finally { setSending(false); }
            };

            return (
                <div className="grid md:grid-cols-2 gap-6">
                    <Card>
                        <div className="text-center">
                            <h2 className="text-2xl font-bold">{employee.name}</h2>
                            <p className="text-indigo-400">{employee.skills.join(' â€¢ ')}</p>
                        </div>
                        <div className="mt-4 space-y-2 text-sm text-gray-300">
                            <div>×˜×œ×¤×•×Ÿ: {employee.phone}</div>
                            <div>××™×™×œ: {employee.email}</div>
                            <div>×™×•× ×”×•×œ×“×ª: {employee.birthday}</div>
                        </div>
                        <Button variant="outline" className="w-full mt-4" onClick={()=>setOpen(true)}>×¢×“×›×•×Ÿ ×¤×¨×˜×™×</Button>
                    </Card>
                    <Card title={`×©×›×¨ ××©×•×¢×¨ (${month})`}>
                        <div className="text-center py-8">
                            <div className="text-4xl font-bold text-green-400">â‚ª{wage}</div>
                            <div className="text-gray-400 text-sm">{myShifts.length} ××©××¨×•×ª</div>
                        </div>
                    </Card>
                    {open && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
                            <div className="bg-gray-900 p-6 rounded-xl w-full max-w-md">
                                <h3 className="text-xl font-bold mb-4">×¢×“×›×•×Ÿ ×¤×¨×˜×™×</h3>
                                <form onSubmit={request} className="space-y-4">
                                    <Input label="×˜×œ×¤×•×Ÿ" name="phone" defaultValue={employee.phone} required />
                                    <Input label="××™×™×œ" name="email" defaultValue={employee.email} required />
                                    <Input label="×›×ª×•×‘×ª" name="address" defaultValue={employee.address} required />
                                    <Input label="×™×•× ×”×•×œ×“×ª" name="birthday" type="date" defaultValue={employee.birthday} required />
                                    <div className="flex gap-2"><Button type="button" variant="secondary" onClick={()=>setOpen(false)} className="flex-1">×‘×™×˜×•×œ</Button><Button type="submit" className="flex-1" disabled={sending}>{sending ? '×©×•×œ×—...' : '×©×œ×— ×‘×§×©×”'}</Button></div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<GRoomApp />);
    </script>
</body>
</html>